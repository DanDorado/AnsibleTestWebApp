#Playbook for online store

---

-
  name: 'Set up the Prerequisites of e-commerce'
  hosts: targets
  tasks:
    
    - name: 'Initialise'
      debug:
        msg: 'Logging into {{  ansible_host  }} with {{  ansible_user  }}'

    - name: 'Install Firewalld'
      yum:
        name: firewalld
        state: present
      become: true
      become_method: sudo

    - name: 'Start Firewalld'
      service: service=firewalld state=started
      become: true
      become_method: sudo

    - name: 'Enable firewalld on system startup'
      command: systemctl enable firewalld
      become: true
      become_method: sudo

    - name: 'Install MariaDB'
      yum:
        name: mariadb-server
        state: present
      become: true
      become_method: sudo

    - name: 'Start Mariadb'
      service: service=mariadb state=started
      become: true
      become_method: sudo

    - name: 'Enable Mariadb on system startup'
      command: systemctl enable mariadb
      become: true
      become_method: sudo

    - name: 'Configure Firewall for Database'
      command: firewall-cmd --permanent --zone=public --add-port=3306/tcp
      become: true
      become_method: sudo
    
    - command: firewall-cmd --reload
      become: true
      become_method: sudo

    - name: 'Modify mysql config to allow first modifications'
      lineinfile:
        path: /etc/my.cnf
        line: "skip-grant-tables"
        regexp: '^(.*)# instructions in http://fedoraproject.org/wiki/Systemd(.*)$'
        backrefs: yes
      become: true
      become_method: sudo

    - name: 'Reload Mariadb with new config'
      command: service mariadb restart
      become: true
      become_method: sudo

-
  name: 'Create MySql database'
  hosts: targets
  tasks:
    - name: 'Create database ecomdb'
      command:  mysql -e "CREATE DATABASE IF NOT EXISTS ecomdb;"

    - name: 'Allow access to DB'
      command: mysql -e "FLUSH PRIVILEGES;"

    - name: 'Create user for ecomdb'
      command: mysql -e "CREATE USER 'ecomuser'@'localhost' IDENTIFIED BY 'ecompassword';"
      become: true
      become_method: sudo

    - name: 'Grant high-level privilages to ecomuser'
      command: mysql -e "GRANT ALL PRIVILEGES ON *.* TO 'ecomuser'@'localhost';"
      become: true
      become_method: sudo

    - name: 'Reset with new privilages'
      command: mysql -e "FLUSH PRIVILEGES;"

    

      

